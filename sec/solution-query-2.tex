\subsection{Query 2}
The second query of the challenge focuses on finding the recent trends among the users of the social network. The implementation is represented in the topology shown in Figure \ref{fig:q2-architecture}. The data needed in this query are comments, likes and friendships. The events are sent downstream, smallest timestamp first. The unique stream is then splitted in two separate stream: one with the friendships which will be used to update the graph, and the other with all the remaining events. The friendships operator connects with Redis, an in-memory key-value database, in which the graph is stored as an adjacency list. Redis is also updated in the case of an user who like a comment but doesn’t have any friends (I feel bad for him, though). The likes and comments are dealt in a number of concurrent operators, in which the distribution of the events is done using Flink keyed streams. This feature automatically divides the events with the same comment unique id, sending all of them towards the same operator.

Those operator will find the range of every comment in the window timerange. This is done by calculating the k maximum cliques of users who liked the same comment, where the comment was posted in a timespan not larger than d seconds. The values d and k are given as input parameters.

Everyone of this operator implements the Bron-Kerbosch algorithm to find the maximum cliques \cite{BronKerbosch1973}. The problem in question is of the np-hard class, so the solution cannot be processed in less than exponential time, for this reason the algorithm is not invoked for every new event, and of course not on the entire graph. In fact the solution recall the Bron-Kerbosch algorithm only for the comment that receives a like, and only on the subgraph built using the users who liked the comment and the set of their neighbours. Once the cliques have been found, the maximum cliques is the largest considering the intersection between the clique and just the likes. The whole set of comments is updated just
in the case of a new friendship. This event could affect the entire graph and its cliques. This also means that the window won’t be always updated in real time as this would be too heavy on the performance. When the operators output the maximum cliques, they need to be ranked. 

This is done using the same approach saw in the query one solution, except the fact that the in this case there isn’t a fixed number 
of element in the final scoring, but this is specified by input.

\begin{figure*}[t]
	\centering
	\includegraphics[width=0.8\textwidth]{img/q2-architecture}
	\caption{Query 2: the topology of operators.}
	\label{fig:q2-architecture}
\end{figure*}